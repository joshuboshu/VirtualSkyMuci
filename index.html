<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tu Mapa Estelar</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <style>
        :root { 
            color-scheme: light;
            --pink-primary: #F17DB1;
            --green-primary: #00B26B;
            --black-primary: #000000;
            --orange-primary: #F37043;
            --purple-primary: #6950A1;
        }
        
        html, body { 
            height: 100%; 
            overflow-x: hidden;
            font-family: 'Poppins', sans-serif;
        }
        
        /* Animaciones de desplazamiento hacia arriba */
        @keyframes slideUpFade {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideUpScale {
            from {
                opacity: 0;
                transform: translateY(40px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
        }
        
        @keyframes pulse-glow {
            0%, 100% { 
                opacity: 0.6;
                box-shadow: 0 0 20px rgba(241, 125, 177, 0.3);
            }
            50% { 
                opacity: 1;
                box-shadow: 0 0 30px rgba(241, 125, 177, 0.5);
            }
        }
        
        .animate-slide-up {
            animation: slideUpFade 0.8s ease-out forwards;
        }
        
        .animate-slide-up-scale {
            animation: slideUpScale 0.6s ease-out forwards;
        }
        
        .animate-float {
            animation: float 6s ease-in-out infinite;
        }
        
        .animate-glow {
            animation: pulse-glow 4s ease-in-out infinite;
        }
        
        /* Transiciones suaves */
        .transition-all-smooth {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Botones minimalistas con nueva paleta */
        .btn-minimal {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border: 2px solid rgba(241, 125, 177, 0.3);
            transition: all 0.4s ease;
            box-shadow: 0 4px 15px rgba(241, 125, 177, 0.1);
        }
        
        .btn-minimal:hover {
            background: rgba(255, 255, 255, 1);
            border-color: var(--pink-primary);
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(241, 125, 177, 0.25);
        }
        
        .btn-minimal:disabled {
            opacity: 0.6;
            transform: none;
            cursor: not-allowed;
        }
        
        .btn-active {
            background: rgba(241, 125, 177, 0.15);
            border-color: var(--pink-primary);
            color: var(--pink-primary);
        }
        
        /* Input minimalista */
        .input-minimal {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(15px);
            border: 2px solid rgba(241, 125, 177, 0.3);
            transition: all 0.4s ease;
            box-shadow: 0 4px 15px rgba(241, 125, 177, 0.1);
        }
        
        .input-minimal:focus {
            background: rgba(255, 255, 255, 1);
            border-color: var(--pink-primary);
            box-shadow: 0 0 0 4px rgba(241, 125, 177, 0.2);
            transform: translateY(-2px);
        }
        
        /* Partículas flotantes */
        .particle {
            position: absolute;
            border-radius: 50%;
        }
        
        .particle-pink {
            background: var(--pink-primary);
            box-shadow: 0 0 10px rgba(241, 125, 177, 0.4);
        }
        
        .particle-green {
            background: var(--green-primary);
            box-shadow: 0 0 10px rgba(0, 178, 107, 0.4);
        }
        
        .particle-orange {
            background: var(--orange-primary);
            box-shadow: 0 0 10px rgba(243, 112, 67, 0.4);
        }
        
        .particle-purple {
            background: var(--purple-primary);
            box-shadow: 0 0 10px rgba(105, 80, 161, 0.4);
        }
        
        /* Mapa circular mejorado */
        .circular-map {
            border-radius: 50%;
            overflow: hidden;
            box-shadow: 
                0 0 0 4px rgba(255, 255, 255, 0.9),
                0 0 0 8px rgba(241, 125, 177, 0.3),
                0 25px 50px rgba(241, 125, 177, 0.2);
        }
        
        /* Estados de visibilidad */
        .hidden-smooth {
            opacity: 0;
            visibility: hidden;
            transform: translateY(30px) scale(0.95);
            transition: all 0.6s ease;
        }
        
        .visible-smooth {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
            transition: all 0.6s ease;
        }
        
        /* Fondo gradiente personalizado */
        .gradient-bg {
            background: linear-gradient(135deg, 
                rgba(241, 125, 177, 0.1) 0%, 
                rgba(0, 178, 107, 0.05) 25%,
                rgba(243, 112, 67, 0.05) 50%,
                rgba(105, 80, 161, 0.1) 100%);
        }
        
        /* Indicador de estado mejorado */
        .status-indicator {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 178, 107, 0.3);
        }
        /* Safe-area (iOS notch) */
        @supports (padding-top: env(safe-area-inset-top)) {
            body { padding-top: env(safe-area-inset-top); }
        }
        /* Micro-breakpoints para dispositivos estrechos (ej. iPhone SE, Galaxy S8) */
        @media (max-width: 360px) {
            header h1 { font-size: 1.5rem !important; padding-left: 4rem !important; padding-right: 4rem !important; }
        }
    </style>
</head>

<body>
    <!-- Pantalla de Bienvenida -->
    <div id="welcome-screen" class="fixed inset-0 z-50 visible-smooth gradient-bg">
        <!-- Partículas flotantes coloridas -->
        <div class="absolute inset-0 overflow-hidden pointer-events-none">
            <div class="particle particle-pink w-3 h-3 animate-float" style="top: 15%; left: 10%; animation-delay: 0s;"></div>
            <div class="particle particle-green w-2 h-2 animate-float" style="top: 70%; left: 85%; animation-delay: 1s;"></div>
            <div class="particle particle-orange w-4 h-4 animate-float" style="top: 25%; left: 75%; animation-delay: 2s;"></div>
            <div class="particle particle-purple w-2 h-2 animate-float" style="top: 85%; left: 15%; animation-delay: 1.5s;"></div>
            <div class="particle particle-pink w-3 h-3 animate-float" style="top: 10%; left: 65%; animation-delay: 3s;"></div>
            <div class="particle particle-green w-2 h-2 animate-float" style="top: 60%; left: 35%; animation-delay: 0.5s;"></div>
            <div class="particle particle-orange w-2 h-2 animate-float" style="top: 40%; left: 90%; animation-delay: 2.5s;"></div>
            <div class="particle particle-purple w-3 h-3 animate-float" style="top: 80%; left: 60%; animation-delay: 4s;"></div>
        </div>
        
        <div class="flex items-center justify-center min-h-screen p-6">
            <div class="text-center max-w-2xl mx-auto">
                <!-- Icono decorativo -->
                <div class="mb-10 animate-slide-up-scale" style="animation-delay: 0.2s;">
                    <div class="w-24 h-24 mx-auto rounded-full flex items-center justify-center animate-glow" 
                         style="background: linear-gradient(135deg, rgba(241, 125, 177, 0.2) 0%, rgba(105, 80, 161, 0.2) 100%);">
                        <i data-lucide="sparkles" class="w-12 h-12" style="color: #F17DB1;"></i>
                    </div>
                </div>
                
                <!-- Texto principal -->
                <h1 class="text-4xl sm:text-5xl lg:text-6xl font-bold mb-6 animate-slide-up" 
                    style="color: #000000; animation-delay: 0.4s;">
                    ¿Cuál es tu
                    <span class="block" style="color: #F17DB1;">fecha especial?</span>
                </h1>
                
                <p class="text-lg sm:text-xl mb-12 animate-slide-up font-medium" 
                   style="color: #6950A1; animation-delay: 0.6s;">
                    Descubre cómo se veía el cielo en ese momento único
                </p>
                
                <!-- Input de fecha -->
                <div class="max-w-md mx-auto space-y-5 animate-slide-up" style="animation-delay: 0.8s;">
                    <div class="relative">
                        <i data-lucide="calendar-heart" class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2" style="color:#F17DB1;"></i>
                        <input id="special-date" 
                               type="datetime-local" 
                               class="input-minimal w-full pl-9 pr-4 py-3 rounded-2xl text-base font-medium focus:outline-none"
                               style="color: #000000;">
                    </div>
                    
                    <button id="continue-btn" 
                            class="btn-minimal w-full px-6 py-3 rounded-2xl text-base font-semibold transition-all-smooth"
                            style="color: #000000;"
                            disabled>
                        <div class="flex items-center justify-center gap-2">
                            <span>Ver mi cielo</span>
                            <i data-lucide="arrow-right" class="w-4 h-4"></i>
                        </div>
                    </button>
                </div>
                
                <!-- Texto decorativo -->
                <div class="mt-12 animate-slide-up" style="animation-delay: 1s;">
                    <p class="text-sm font-semibold" style="color: #6950A1;">
                        ✦ Tu mapa estelar personalizado ✦
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Pantalla Principal del Mapa -->
    <div id="main-screen" class="hidden-smooth min-h-screen gradient-bg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            
            <!-- Header minimalista -->
            <header class="relative text-center mb-8">
                <button id="back-btn" class="btn-minimal px-3 py-2 rounded-xl absolute left-3 top-3 sm:left-6 sm:top-6 z-10">
                    <i data-lucide="arrow-left" class="w-5 h-5" style="color: #000000;"></i>
                </button>

                <h1 class="text-2xl sm:text-4xl lg:text-5xl font-bold mb-3 px-12 sm:px-0" style="color: #000000;">
                    Tu mapa estelar
                </h1>
                <p class="text-lg font-medium" style="color: #6950A1;" id="selected-date-display">
                    <!-- La fecha seleccionada aparecerá aquí -->
                </p>
            </header>

            <!-- Controles minimalistas -->
            <div class="flex flex-wrap items-center justify-center gap-4 mb-12">
                <div class="btn-minimal px-4 py-3 rounded-xl w-full sm:w-auto">
                    <div class="relative w-full sm:w-72">
                        <i data-lucide="calendar" class="w-4 h-4 absolute left-2 top-1/2 -translate-y-1/2" style="color:#F17DB1;"></i>
                        <input id="dt" type="datetime-local" 
                               class="bg-transparent border-none focus:outline-none text-sm font-medium w-full pl-7 pr-12" 
                               style="color: #000000;" />
                        <div class="absolute right-2 top-1/2 -translate-y-1/2 flex items-center gap-1 text-slate-500">
                            <i data-lucide="clock-3" class="w-4 h-4" style="color:#F17DB1;"></i>
                        </div>
                    </div>
                </div>
                
                <!-- <button id="btn-now" class="btn-minimal px-4 py-3 rounded-xl text-sm font-semibold w-full sm:w-auto flex items-center justify-center gap-2" style="color: #000000;">
                    <i data-lucide="clock-3" class="w-4 h-4"></i>
                    <span>Ahora</span>
                </button> -->
                
                <button id="btn-names" class="btn-minimal px-4 py-3 rounded-xl text-sm font-semibold w-full sm:w-auto flex items-center justify-center gap-2" style="color: #000000;">
                    <i data-lucide="tag" class="w-4 h-4"></i>
                    <span>Nombres</span>
                </button>
                
                <button id="btn-const" class="btn-minimal px-4 py-3 rounded-xl text-sm font-semibold w-full sm:w-auto flex items-center justify-center gap-2" style="color: #000000;">
                    <i data-lucide="stars" class="w-4 h-4"></i>
                    <span>Constelaciones</span>
                </button>
            </div>

            <!-- Mapa estelar circular más grande -->
            <main class="flex justify-center mb-12">
                <div class="relative">
                    <div id="starmap" class="circular-map w-[92vw] h-[92vw] max-w-[28rem] max-h-[28rem] md:w-[38rem] md:h-[38rem] md:max-w-[38rem] md:max-h-[38rem] lg:w-[48rem] lg:h-[48rem] lg:max-w-[48rem] lg:max-h-[48rem] xl:w-[56rem] xl:h-[56rem] xl:max-w-[56rem] xl:max-h-[56rem] bg-black" ondblclick="return false;"></div>
                </div>
            </main>

            <!-- Generador de póster + envío opcional por correo -->
            <div class="max-w-2xl mx-auto">
                <div class="btn-minimal rounded-2xl p-5 sm:p-8 mb-6">
                    <h3 class="text-2xl font-bold mb-6 text-center" style="color: #000000;">
                        Crear póster personalizado
                    </h3>
                    
                    <button id="btn-poster" 
                            class="btn-minimal w-full mt-4 px-5 py-3 sm:px-6 sm:py-4 rounded-xl text-sm font-semibold transition-all-smooth"
                            style="color: #000000;">
                        <div class="flex items-center justify-center gap-2">
                            <i data-lucide="download" class="w-5 h-5"></i>
                            <span>Descargar póster</span>
                        </div>
                    </button>

                    <div class="mt-6 grid gap-3">
                        <div class="relative">
                            <i data-lucide="mail" class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2" style="color:#F17DB1;"></i>
                            <input id="email-to" type="email" placeholder="correo@ejemplo.com" class="input-minimal w-full pl-9 pr-3 py-3 rounded-xl text-sm focus:outline-none" style="color:#000000;" />
                        </div>
                        <p class="text-xs" style="color:#6950A1;">Agrega tu correo si quieres enviar esta imagen del cielo de tu fecha especial.</p>
                        <button id="btn-send-email" class="btn-minimal w-full px-5 py-3 rounded-xl text-sm font-semibold transition-all-smooth disabled:opacity-50 disabled:cursor-not-allowed" style="color:#000000;" disabled>
                            <div class="flex items-center justify-center gap-2">
                                <i data-lucide="send" class="w-5 h-5"></i>
                                <span>Enviar por correo</span>
                            </div>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Footer ampliado -->
            <footer class="text-center mt-8">
                <div class="btn-minimal inline-block px-4 py-3 rounded-xl w-full sm:w-auto">
                    <p class="text-xs text-center" style="color:#000000;">
                        © <span id="copyright-year"></span> <strong>Joshua Colman Lombardo</strong> • Proyecto del <strong>MuCi</strong>
                    </p>
                </div>
            </footer>
        </div>
    </div>

    <!-- Scripts de VirtualSky -->
    <script src="../stuquery.js"></script>
    <script src="../virtualsky.js"></script>
    <script src="../virtualsky-planets.js"></script>
    <!-- EmailJS (browser SDK) -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <script>
        // Inicializar iconos
        lucide.createIcons();
        
        let vs;
        let namesOn = false; // Por defecto desactivado
        let constOn = false; // Por defecto desactivado
        // Configuración del envío por correo (rellenar si se tiene backend disponible)
        // EmailJS config (rellenar con tus datos de EmailJS)
        const EMAILJS_PUBLIC_KEY = '';
        const EMAILJS_SERVICE_ID = '';
        const EMAILJS_TEMPLATE_ID = '';
        // Opcional: endpoint serverless si prefieres enviar desde backend en vez de EmailJS
        const SEND_EMAIL_ENDPOINT = '';
        const COPYRIGHT_NAME = 'Joshua Colman Lombardo';
        const MUCI_EMAIL = 'contacto@muci.org';
        document.addEventListener('DOMContentLoaded',()=>{
            const yEl = document.getElementById('copyright-year');
            if(yEl) yEl.textContent = new Date().getFullYear();
            // Inicializar EmailJS si se definió la clave pública
            try{ if(EMAILJS_PUBLIC_KEY) emailjs.init(EMAILJS_PUBLIC_KEY); }catch(_){ }
            // Habilitar/deshabilitar botón de envío de correo según email válido
            const emailInput = document.getElementById('email-to');
            const btnSend = document.getElementById('btn-send-email');
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            function refreshBtn(){
                btnSend.disabled = !emailRegex.test((emailInput?.value||'').trim());
            }
            emailInput?.addEventListener('input', refreshBtn);
            refreshBtn();
        });

        // Elementos del DOM
        const welcomeScreen = document.getElementById('welcome-screen');
        const mainScreen = document.getElementById('main-screen');
        const specialDateInput = document.getElementById('special-date');
        const continueBtn = document.getElementById('continue-btn');
        const backBtn = document.getElementById('back-btn');
        const selectedDateDisplay = document.getElementById('selected-date-display');

        // Función para formatear fecha
        function formatDate(dateString) {
            const date = new Date(dateString);
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit' 
            };
            return date.toLocaleDateString('es-ES', options);
        }

        function setLocalDatetimeInput(date, inputId = 'dt') {
            const d = new Date(date instanceof Date ? date : Date.now());
            const local = new Date(d.getTime() - d.getTimezoneOffset() * 60000)
                .toISOString().slice(0, 16);
            document.getElementById(inputId).value = local;
        }

        // Configurar fecha inicial
        setLocalDatetimeInput(new Date(), 'special-date');

        // Habilitar botón cuando se selecciona fecha
        specialDateInput.addEventListener('change', () => {
            continueBtn.disabled = !specialDateInput.value;
            if (specialDateInput.value) {
                continueBtn.style.background = 'rgba(241, 125, 177, 0.15)';
                continueBtn.style.borderColor = '#F17DB1';
                continueBtn.style.color = '#F17DB1';
            }
        });

        // Transición a pantalla principal con efecto de desplazamiento
        continueBtn.addEventListener('click', () => {
            if (!specialDateInput.value) return;
            
            // Mostrar fecha seleccionada
            selectedDateDisplay.textContent = formatDate(specialDateInput.value);
            
            // Transición suave hacia arriba
            welcomeScreen.style.transform = 'translateY(-100%)';
            welcomeScreen.style.opacity = '0';
            
            setTimeout(() => {
                welcomeScreen.style.display = 'none';
                mainScreen.style.display = 'block';
                mainScreen.style.transform = 'translateY(0)';
                mainScreen.classList.remove('hidden-smooth');
                mainScreen.classList.add('visible-smooth');
                
                // Inicializar VirtualSky
                setTimeout(initializeVirtualSky, 300);
                
                // Configurar fecha seleccionada
                setLocalDatetimeInput(new Date(specialDateInput.value));
            }, 600);
        });

        // Botón volver: recargar la página para un reinicio limpio
        backBtn.addEventListener('click', () => {
            window.location.reload();
        });

        function initializeVirtualSky() {
            vs = S.virtualsky({
                id: 'starmap',
                projection: 'fisheye',
                showstars: true,
                showplanets: true,
                constellationlabels: false, // Desactivado por defecto
                constellations: false,      // Desactivado por defecto
                showplanetlabels: false,    // Desactivado por defecto
                showstarlabels: false,      // Desactivado por defecto
                showgalaxy: true,
                magnitude: 6,
                scalestars: 1.2,
                mouse: false,
                keyboard: false,
                showdate: false,
                showposition: false,
                gradient: true,
                cardinalpoints: false,      // Desactivado por defecto
                latitude: -25.2637, // Asunción, Paraguay
                longitude: -57.5759
            });

            // Configurar fecha inicial
            vs.setClock(new Date(specialDateInput.value));
            vs.draw();

            // Controles
            // document.getElementById('btn-now').addEventListener('click', () => {
            //     const now = new Date();
            //     vs.setClock(now);
            //     setLocalDatetimeInput(now);
            //     vs.draw();
            // });

            document.getElementById('dt').addEventListener('change', (e) => {
                const d = new Date(e.target.value);
                vs.setClock(d);
                vs.draw();
            });

            document.getElementById('btn-names').addEventListener('click', () => {
                namesOn = !namesOn;
                vs.showstarlabels = namesOn;
                vs.showplanetlabels = namesOn;
                // Solo mostrar nombres de constelaciones si hay líneas activas
                vs.constellation.labels = namesOn && vs.constellation.lines;
                // Cardinales ligados al estado de Nombres
                vs.cardinalpoints = namesOn;
                vs.checkLoaded();
                vs.draw();
                
                const btn = document.getElementById('btn-names');
                if (namesOn) {
                    btn.classList.add('btn-active');
                } else {
                    btn.classList.remove('btn-active');
                }
            });

            document.getElementById('btn-const').addEventListener('click', () => {
                // Usar el método incorporado para manejar carga de datos y redibujado
                vs.toggleConstellationLines();
                const isOn = vs.constellation.lines === true;
                // Sincronizar etiquetas con el estado de Nombres
                vs.constellation.labels = isOn && namesOn;
                vs.checkLoaded();
                vs.draw();
                
                const btn = document.getElementById('btn-const');
                if (isOn) {
                    btn.classList.add('btn-active');
                } else {
                    btn.classList.remove('btn-active');
                }
            });

            // Generador de póster (estilo lámina blanca con borde y Poppins)
            document.getElementById('btn-poster').addEventListener('click', async () => {
                const btn = document.getElementById('btn-poster');
                const originalContent = btn.innerHTML;
                
                btn.innerHTML = '<div class="flex items-center justify-center gap-2"><i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i><span>Generando...</span></div>';
                lucide.createIcons();
                btn.disabled = true;

                try {
                    // Captura el canvas visible en el DOM
                    const skyCanvas = document.querySelector('#starmap canvas');
                    if (!skyCanvas) throw new Error('No se encontró el canvas del cielo');

                    // A4 en píxeles
                    const PW = 2480, PH = 3508;
                    const poster = document.createElement('canvas');
                    poster.width = PW;
                    poster.height = PH;
                    const ctx = poster.getContext('2d');

                    // Fondo blanco y borde azul marino
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, PW, PH);
                    const margin = 140;
                    ctx.strokeStyle = '#0b1b3d';
                    ctx.lineWidth = 6;
                    ctx.strokeRect(margin, margin, PW - margin*2, PH - margin*2);

                    // Círculo del cielo según referencia
                    const circleR = 850;
                    const circleX = PW/2;
                    const circleY = 1180;
                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(circleX, circleY, circleR, 0, Math.PI * 2);
                    ctx.closePath();
                    ctx.clip();
                    // Ajusta el tamaño del canvas fuente al círculo destino
                    ctx.drawImage(
                        skyCanvas,
                        0, 0, skyCanvas.width, skyCanvas.height,
                        circleX - circleR, circleY - circleR, circleR * 2, circleR * 2
                    );
                    ctx.restore();

                    // Construir textos (Poppins) con tamaño más grande
                    const msg = (document.getElementById('poster-msg')?.value || 'Nuestro primer beso bajo este mágico cielo nocturno').trim();
                    const place = (document.getElementById('poster-place')?.value || 'Asunción').trim();
                    const dtVal = (document.getElementById('dt')?.value || specialDateInput.value);
                    const dt = new Date(dtVal);
                    const dateStr = `${String(dt.getDate()).padStart(2,'0')}-${String(dt.getMonth()+1).padStart(2,'0')}-${dt.getFullYear()}`;

                    // Coordenadas desde VirtualSky (lat/long en DMS)
                    const toDMS = (deg, isLat) => {
                        const sign = deg >= 0 ? 1 : -1;
                        const abs = Math.abs(deg);
                        const D = Math.floor(abs);
                        const Mfloat = (abs - D) * 60;
                        const M = Math.floor(Mfloat);
                        const S = Math.round((Mfloat - M) * 60);
                        const hemi = isLat ? (sign >= 0 ? 'N' : 'S') : (sign >= 0 ? 'E' : 'W');
                        return `${D}° ${String(M).padStart(2,'0')}' ${String(S).padStart(2,'0')}" ${hemi}`;
                    };
                    const latDeg = (vs?.latitude?.deg != null) ? vs.latitude.deg : 0;
                    const lonDeg = (vs?.longitude?.deg != null) ? vs.longitude.deg : 0;
                    const coords = `${toDMS(latDeg, true)}  ${toDMS(lonDeg, false)}`;

                    ctx.fillStyle = '#0b1b3d';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'alphabetic';
                    ctx.font = '600 80px Poppins';  // Mensaje principal (más grande)
                    ctx.fillText(msg, PW/2, circleY + circleR + 200);

                    ctx.font = '600 64px Poppins';  // Lugar (más grande)
                    ctx.fillText(place, PW/2, circleY + circleR + 320);

                    ctx.font = '500 54px Poppins';  // Coordenadas (más grande)
                    ctx.fillText(coords, PW/2, circleY + circleR + 390);

                    ctx.font = '500 54px Poppins';  // Fecha (más grande)
                    ctx.fillText(dateStr, PW/2, circleY + circleR + 460);

                    const dataUrl = poster.toDataURL('image/png', 1.0);
                    const a = document.createElement('a');
                    a.download = `mapa-estelar-${Date.now()}.png`;
                    a.href = dataUrl;
                    a.click();

                    // Opcional: envío de imagen por correo
                    const wantEmail = document.getElementById('email-enable')?.checked;
                    const to = (document.getElementById('email-to')?.value || '').trim();
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (wantEmail && emailRegex.test(to)) {
                        if (SEND_EMAIL_ENDPOINT) {
                            try {
                                await fetch(SEND_EMAIL_ENDPOINT, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        to,
                                        subject: 'Tu mapa estelar — MuCi',
                                        message: `${msg}\n\nGenerado por MuCi • Autor: ${COPYRIGHT_NAME}`,
                                        filename: 'mapa-estelar.png',
                                        imageBase64: dataUrl.split(',')[1]
                                    })
                                });
                                alert('Imagen enviada al correo especificado.');
                            } catch (err) {
                                alert('No se pudo enviar por correo desde el navegador. Intenta nuevamente o descarga y envía manualmente.');
                            }
                        } else {
                            const subject = encodeURIComponent('Tu mapa estelar — MuCi');
                            const body = encodeURIComponent(`${msg}\n\nAdjunta la imagen descargada a este correo.\n\nMuCi • Autor: ${COPYRIGHT_NAME}\nContacto: ${MUCI_EMAIL}`);
                            window.location.href = `mailto:${to}?subject=${subject}&body=${body}`;
                        }
                    }
                    // Guardar última imagen generada en memoria para el botón de envío manual
                    window.__posterLastDataUrl = dataUrl;

                } catch (e) {
                    alert('Error generando el póster: ' + e.message);
                } finally {
                    // Limpiar offscreen si quedó en el DOM
                    const off = document.getElementById('starmap_export');
                    if (off) off.remove();
                    btn.innerHTML = originalContent;
                    btn.disabled = false;
                    lucide.createIcons();
                }
            });

            // Botón de envío por correo (no requiere descargar antes)
            const btnSend = document.getElementById('btn-send-email');
            btnSend?.addEventListener('click', async () => {
                const to = (document.getElementById('email-to')?.value || '').trim();
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(to)) return alert('Ingresa un correo válido');
                // Generar offscreen para obtener imagen sin alterar la vista
                let dataUrl;
                try {
                    // Captura el canvas visible en el DOM
                    const skyCanvas = document.querySelector('#starmap canvas');
                    if (!skyCanvas) throw new Error('No se encontró el canvas del cielo');

                    // Componer póster como en descarga
                    const PW = 2480, PH = 3508;
                    const poster = document.createElement('canvas');
                    poster.width = PW; poster.height = PH;
                    const ctx = poster.getContext('2d');
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, PW, PH);
                    const margin = 140;
                    ctx.strokeStyle = '#0b1b3d';
                    ctx.lineWidth = 6;
                    ctx.strokeRect(margin, margin, PW - margin*2, PH - margin*2);
                    const circleR = 850, circleX = PW/2, circleY = 1180;
                    ctx.save();
                    ctx.beginPath(); ctx.arc(circleX, circleY, circleR, 0, Math.PI*2); ctx.clip();
                    ctx.drawImage(
                        skyCanvas,
                        0, 0, skyCanvas.width, skyCanvas.height,
                        circleX - circleR, circleY - circleR, circleR * 2, circleR * 2
                    );
                    ctx.restore();
                    const msg = (document.getElementById('poster-msg')?.value || 'Nuestro primer beso bajo este mágico cielo nocturno').trim();
                    const place = (document.getElementById('poster-place')?.value || 'Asunción').trim();
                    const dt = new Date(document.getElementById('dt')?.value || specialDateInput.value);
                    const dateStr = `${String(dt.getDate()).padStart(2,'0')}-${String(dt.getMonth()+1).padStart(2,'0')}-${dt.getFullYear()}`;
                    const toDMS = (deg, isLat)=>{const s=deg>=0?1:-1,a=Math.abs(deg),D=Math.floor(a),Mf=(a-D)*60,M=Math.floor(Mf),S=Math.round((Mf-M)*60),h=isLat?(s>=0?'N':'S'):(s>=0?'E':'W');return `${D}° ${String(M).padStart(2,'0')}' ${String(S).padStart(2,'0')}" ${h}`};
                    const latDeg = (vs?.latitude?.deg != null) ? vs.latitude.deg : 0;
                    const lonDeg = (vs?.longitude?.deg != null) ? vs.longitude.deg : 0;
                    const coords = `${toDMS(latDeg, true)}  ${toDMS(lonDeg, false)}`;
                    ctx.fillStyle = '#0b1b3d';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'alphabetic';

                    ctx.font = '600 80px Poppins';  // Mensaje principal (más grande)
                    ctx.fillText(msg, PW/2, circleY + circleR + 200);

                    ctx.font = '600 64px Poppins';  // Lugar (más grande)
                    ctx.fillText(place, PW/2, circleY + circleR + 320);

                    ctx.font = '500 54px Poppins';  // Coordenadas (más grande)
                    ctx.fillText(coords, PW/2, circleY + circleR + 390);

                    ctx.font = '500 54px Poppins';  // Fecha (más grande)
                    ctx.fillText(dateStr, PW/2, circleY + circleR + 460);

                    // Para email, reduce tamaño y usa JPEG para menor peso
                    dataUrl = poster.toDataURL('image/jpeg', 0.92);
                    document.getElementById('starmap_export_mail')?.remove();
                } catch(err){
                    return alert('No se pudo generar la imagen para enviar.');
                }
                // Enviar con EmailJS si está configurado
                if (EMAILJS_PUBLIC_KEY && EMAILJS_SERVICE_ID && EMAILJS_TEMPLATE_ID) {
                    try{
                        const params = {
                            to_email: to,
                            subject: 'Tu mapa estelar — MuCi',
                            message: `Generado por MuCi • Autor: ${COPYRIGHT_NAME}`,
                            image_base64: dataUrl
                        };
                        await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, params);
                        alert('Correo enviado con EmailJS.');
                        return;
                    }catch(e){
                        console.warn('EmailJS fallo, probando endpoint/mailing local', e);
                    }
                }
                if (SEND_EMAIL_ENDPOINT) {
                    try {
                        await fetch(SEND_EMAIL_ENDPOINT, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                to,
                                subject: 'Tu mapa estelar — MuCi',
                                message: `Generado por MuCi • Autor: ${COPYRIGHT_NAME}`,
                                filename: 'mapa-estelar.png',
                                imageBase64: (dataUrl||'').split(',')[1]
                            })
                        });
                        alert('Imagen enviada al correo especificado.');
                    } catch (err) {
                        alert('No se pudo enviar por correo desde el navegador.');
                    }
                } else {
                    const subject = encodeURIComponent('Tu mapa estelar — MuCi');
                    const body = encodeURIComponent(`Adjunta la imagen (descargada) a este correo.\n\nMuCi • Autor: ${COPYRIGHT_NAME}\nContacto: ${MUCI_EMAIL}`);
                    window.location.href = `mailto:${to}?subject=${subject}&body=${body}`;
                }
            });
        }
    </script>
</body>
</html>
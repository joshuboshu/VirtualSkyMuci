<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tu Mapa Estelar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="./main.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- Importa el módulo del SDK de Supabase para subida -->
    <script type="module">
        import { uploadImageFromDataUrl } from './supabase-upload.js';
        window.uploadImageFromDataUrl = uploadImageFromDataUrl;
    </script>
</head>
<body>
    <!-- Pantalla de Bienvenida -->
    <div id="welcome-screen" class="fixed inset-0 z-50 visible-smooth gradient-bg">
        <!-- Partículas flotantes coloridas -->
        <div class="absolute inset-0 overflow-hidden pointer-events-none">
            <div class="particle particle-pink w-3 h-3 animate-float" style="top: 15%; left: 10%; animation-delay: 0s;"></div>
            <div class="particle particle-green w-2 h-2 animate-float" style="top: 70%; left: 85%; animation-delay: 1s;"></div>
            <div class="particle particle-orange w-4 h-4 animate-float" style="top: 25%; left: 75%; animation-delay: 2s;"></div>
            <div class="particle particle-purple w-2 h-2 animate-float" style="top: 85%; left: 15%; animation-delay: 1.5s;"></div>
            <div class="particle particle-pink w-3 h-3 animate-float" style="top: 10%; left: 65%; animation-delay: 3s;"></div>
            <div class="particle particle-green w-2 h-2 animate-float" style="top: 60%; left: 35%; animation-delay: 0.5s;"></div>
            <div class="particle particle-orange w-2 h-2 animate-float" style="top: 40%; left: 90%; animation-delay: 2.5s;"></div>
            <div class="particle particle-purple w-3 h-3 animate-float" style="top: 80%; left: 60%; animation-delay: 4s;"></div>
        </div>
        
        <div class="flex items-center justify-center min-h-screen p-6">
            <div class="text-center max-w-2xl mx-auto">
                <!-- Icono decorativo -->
                <div class="mb-10 animate-slide-up-scale" style="animation-delay: 0.2s;">
                    <div class="w-24 h-24 mx-auto rounded-full flex items-center justify-center animate-glow" 
                         style="background: linear-gradient(135deg, rgba(241, 125, 177, 0.2) 0%, rgba(105, 80, 161, 0.2) 100%);">
                        <i data-lucide="sparkles" class="w-12 h-12" style="color: #F17DB1;"></i>
                    </div>
                </div>
                
                <!-- Texto principal -->
                <h1 class="text-4xl sm:text-5xl lg:text-6xl font-bold mb-6 animate-slide-up" 
                    style="color: #000000; animation-delay: 0.4s;">
                    ¿Cuál es tu
                    <span class="block" style="color: #F17DB1;">fecha especial?</span>
                </h1>
                
                <p class="text-lg sm:text-xl mb-12 animate-slide-up font-medium" 
                   style="color: #6950A1; animation-delay: 0.6s;">
                    Descubre cómo se veía el cielo en ese momento único
                </p>
                
                <!-- Input de fecha -->
                <div class="max-w-md mx-auto space-y-5 animate-slide-up" style="animation-delay: 0.8s;">
                    <div class="relative">
                        <i data-lucide="calendar-heart" class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2" style="color:#F17DB1;"></i>
                        <input id="special-date" 
                               type="datetime-local" 
                               class="input-minimal w-full pl-9 pr-4 py-3 rounded-2xl text-base font-medium focus:outline-none"
                               style="color: #000000;">
                    </div>
                    
                    <button id="continue-btn" 
                            class="btn-minimal w-full px-6 py-3 rounded-2xl text-base font-semibold transition-all-smooth"
                            style="color: #000000;"
                            disabled>
                        <div class="flex items-center justify-center gap-2">
                            <span>Ver mi cielo</span>
                            <i data-lucide="arrow-right" class="w-4 h-4"></i>
                        </div>
                    </button>
                </div>
                
                <!-- Texto decorativo -->
                <div class="mt-12 animate-slide-up" style="animation-delay: 1s;">
                    <p class="text-sm font-semibold" style="color: #6950A1;">
                        ✦ Tu mapa estelar personalizado ✦
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Pantalla Principal del Mapa -->
    <div id="main-screen" class="hidden-smooth min-h-screen gradient-bg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            
            <!-- Header minimalista -->
            <header class="relative text-center mb-8">
                <button id="back-btn" class="btn-minimal px-3 py-2 rounded-xl absolute left-3 top-3 sm:left-6 sm:top-6 z-10">
                    <i data-lucide="arrow-left" class="w-5 h-5" style="color: #000000;"></i>
                </button>

                <h1 class="text-2xl sm:text-4xl lg:text-5xl font-bold mb-3 px-12 sm:px-0" style="color: #000000;">
                    Tu mapa estelar
                </h1>
                <p class="text-lg font-medium" style="color: #6950A1;" id="selected-date-display">
                    <!-- La fecha seleccionada aparecerá aquí -->
                </p>
            </header>

            <!-- Controles minimalistas -->
            <div class="flex flex-wrap items-center justify-center gap-4 mb-12">
                <div class="btn-minimal px-4 py-3 rounded-xl w-full sm:w-auto">
                    <div class="relative w-full sm:w-72">
                        <i data-lucide="calendar" class="w-4 h-4 absolute left-2 top-1/2 -translate-y-1/2" style="color:#F17DB1;"></i>
                        <input id="dt" type="datetime-local" 
                               class="bg-transparent border-none focus:outline-none text-sm font-medium w-full pl-7 pr-12" 
                               style="color: #000000;" />
                        <div class="absolute right-2 top-1/2 -translate-y-1/2 flex items-center gap-1 text-slate-500">
                            <i data-lucide="clock-3" class="w-4 h-4" style="color:#F17DB1;"></i>
                        </div>
                    </div>
                </div>
                
                <button id="btn-names" class="btn-minimal px-4 py-3 rounded-xl text-sm font-semibold w-full sm:w-auto flex items-center justify-center gap-2" style="color: #000000;">
                    <i data-lucide="tag" class="w-4 h-4"></i>
                    <span>Nombres</span>
                </button>
                
                <button id="btn-const" class="btn-minimal px-4 py-3 rounded-xl text-sm font-semibold w-full sm:w-auto flex items-center justify-center gap-2" style="color: #000000;">
                    <i data-lucide="stars" class="w-4 h-4"></i>
                    <span>Constelaciones</span>
                </button>
            </div>

            <!-- Mapa estelar circular más grande -->
            <main class="flex justify-center mb-12">
                <div class="relative">
                    <div id="starmap" class="circular-map w-[92vw] h-[92vw] max-w-[28rem] max-h-[28rem] md:w-[38rem] md:h-[38rem] md:max-w-[38rem] md:max-h-[38rem] lg:w-[48rem] lg:h-[48rem] lg:max-w-[48rem] lg:max-h-[48rem] xl:w-[56rem] xl:h-[56rem] xl:max-w-[56rem] xl:max-h-[56rem] bg-black select-none pointer-events-none" ondblclick="return false;" style="touch-action:none; user-select:none; position:relative;">
                        <!-- El canvas de VirtualSky se inyecta aquí -->
                    </div>
                    <!-- Capa overlay para bloquear clics/taps en responsive y desktop -->
                    <div id="starmap-blocker"
                        class="absolute inset-0 z-20"
                        style="pointer-events:all; background:transparent; touch-action:none; user-select:none;"></div>
                </div>
            </main>

            <!-- Generador de póster + envío opcional por correo -->
            <div class="max-w-2xl mx-auto">
                <div class="btn-minimal rounded-2xl p-5 sm:p-8 mb-6">
                    <h3 class="text-2xl font-bold mb-6 text-center" style="color: #000000;">
                        Crear póster personalizado
                    </h3>
                    <!-- NUEVO INPUT para frase personalizada antes del correo -->
                    <div class="mb-4">
                        <input id="poster-msg" 
                            type="text" 
                            maxlength="80"
                            placeholder="Agrega una frase especial (opcional)"
                            class="input-minimal w-full px-4 py-3 rounded-xl text-base font-medium focus:outline-none"
                            style="color: #000000;"
                        />
                        <p class="text-xs mt-1" style="color:#6950A1;">
                            Si no escribes nada, se usará: "Nuestro primer beso bajo este mágico cielo nocturno"
                        </p>
                    </div>
                    
                    <!-- Modal flotante para previsualización -->
                    <div id="poster-modal" class="fixed inset-0 z-50 bg-black bg-opacity-60 flex items-center justify-center hidden">
                        <div class="bg-white rounded-2xl shadow-2xl p-4 max-w-full" style="max-width:440px;">
                            <div class="flex justify-end">
                                <button id="close-poster-modal" class="text-gray-400 hover:text-pink-500 text-2xl font-bold">&times;</button>
                            </div>
                            <img id="poster-preview-img" class="rounded-xl border border-pink-200 shadow-lg max-w-full" style="max-width:420px;max-height:600px;" alt="Previsualización del póster"/>
                        </div>
                    </div>
                    
                    <div class="mt-6 grid gap-3">
                        <div class="relative">
                            <i data-lucide="mail" class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2" style="color:#F17DB1;"></i>
                            <input id="email-to" type="email" placeholder="correo@ejemplo.com" class="input-minimal w-full pl-9 pr-3 py-3 rounded-xl text-sm focus:outline-none" style="color:#000000;" />
                        </div>
                        <p class="text-xs" style="color:#6950A1;">Agrega tu correo si quieres enviar esta imagen del cielo de tu fecha especial.</p>
                        <!-- Sustituye el botón de enviar correo por uno con spinner y texto dinámico -->
                        <button id="btn-send-email" class="btn-minimal w-full px-5 py-3 rounded-xl text-sm font-semibold transition-all-smooth disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2" style="color:#000000;" disabled>
                            <span id="btn-send-email-text">Enviar por correo</span>
                            <span id="btn-send-email-spinner" class="hidden"><i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i></span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Footer ampliado -->
            <footer class="text-center mt-8">
                <div class="btn-minimal inline-block px-4 py-3 rounded-xl w-full sm:w-auto">
                    <p class="text-xs text-center" style="color:#000000;">
                        © <span id="copyright-year"></span> <strong>Joshua Colman Lombardo</strong> • Proyecto del <strong>MuCi</strong>
                    </p>
                </div>
            </footer>
        </div>
    </div>

    <!-- Toast para alertas bonitas -->
    <div id="toast-email" class="fixed left-1/2 bottom-8 z-50 px-6 py-4 rounded-2xl shadow-lg bg-gradient-to-r from-pink-100 to-purple-100 border border-pink-200 text-pink-800 font-semibold text-base opacity-0 pointer-events-none transition-all duration-500 -translate-x-1/2">
        <span id="toast-email-msg"></span>
    </div>
    <!-- Scripts de VirtualSky -->
    <script src="./stuquery.js"></script>
    <script src="./virtualsky.js"></script>
    <script src="./virtualsky-planets.js"></script>
    <!-- EmailJS (browser SDK) -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <script src="./main.js"></script>
</body>
</html>